<!DOCTYPE html>
<html lang="{{ get_current_language() }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ _('ç®¡ç†å‘˜ç™»å½• - æœè”¬å®¢æœAIç³»ç»Ÿ') }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}?v=20241231">
</head>
<body class="login-page">
    <!-- è¯­è¨€åˆ‡æ¢èœå• -->
    <div class="language-switcher">
        <select id="languageSelect" onchange="changeLanguage(this.value)">
            <option value="zh" {% if get_current_language() == 'zh' %}selected{% endif %}>ğŸ‡¨ğŸ‡³ {{ _('ç®€ä½“ä¸­æ–‡') }}</option>
            <option value="en" {% if get_current_language() == 'en' %}selected{% endif %}>ğŸ‡ºğŸ‡¸ {{ _('English') }}</option>
        </select>
    </div>

    <div class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>ğŸğŸ¥¬ {{ _('ç®¡ç†å‘˜ç™»å½•') }}</h1>
                <p>{{ _('æœè”¬å®¢æœAIç³»ç»Ÿåå°ç®¡ç†') }}</p>
                <p style="color: #28a745; font-size: 12px;">ğŸ”„ é¡µé¢å·²æ›´æ–° - ç‰ˆæœ¬ 20241231</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">{{ _('ç”¨æˆ·å') }}</label>
                    <input type="text" id="username" name="username" required>
                </div>

                <div class="form-group">
                    <label for="password">{{ _('å¯†ç ') }}</label>
                    <input type="password" id="password" name="password" required>
                </div>

                <button type="submit" class="login-btn">{{ _('ç™»å½•') }}</button>

                <!-- è¯­è¨€æµ‹è¯•æŒ‰é’® -->
                <button type="button" onclick="testLanguageNow()" style="background: #28a745; color: white; border: none; padding: 10px 20px; margin-top: 10px; border-radius: 4px; cursor: pointer; width: 100%;">
                    ğŸ§ª ç«‹å³æµ‹è¯•è¯­è¨€åˆ‡æ¢
                </button>

                <div id="errorMessage" class="error-message" style="display: none;"></div>
                <div id="testResult" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; display: none; font-family: monospace; font-size: 12px;"></div>
            </form>

            <div class="login-footer">
                <p>{{ _('é»˜è®¤è´¦æˆ·ï¼šadmin / admin123') }}</p>
                <p><a href="/">{{ _('è¿”å›å®¢æœç³»ç»Ÿ') }}</a></p>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('errorMessage');
            
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°ç®¡ç†é¡µé¢
                    window.location.href = '/admin/dashboard';
                } else {
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    errorDiv.textContent = result.error || '{{ _("ç™»å½•å¤±è´¥") }}';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = '{{ _("ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•") }}';
                errorDiv.style.display = 'block';
            }
        });

        // è¯­è¨€åˆ‡æ¢å‡½æ•°
        function changeLanguage(language) {
            fetch(`/api/language/${language}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => response.json())
            .then(result => {
                if (result.success) {
                    // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨æ–°è¯­è¨€
                    window.location.reload();
                } else {
                    console.error('è¯­è¨€åˆ‡æ¢å¤±è´¥:', result.error);
                }
            }).catch(error => {
                console.error('è¯­è¨€åˆ‡æ¢å¤±è´¥:', error);
            });
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function showTestResult(message, isError = false) {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.style.color = isError ? '#dc3545' : '#28a745';
            resultDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
        }

        // ç«‹å³æµ‹è¯•è¯­è¨€åˆ‡æ¢
        function testLanguageNow() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = '';
            resultDiv.style.display = 'block';

            showTestResult('å¼€å§‹è¯­è¨€åˆ‡æ¢æµ‹è¯•...');

            // æµ‹è¯•1: è·å–å½“å‰è¯­è¨€
            fetch('/api/language')
                .then(r => r.json())
                .then(data => {
                    showTestResult(`å½“å‰è¯­è¨€: ${data.current_language.code}`);
                    showTestResult(`å¯ç”¨è¯­è¨€: ${data.available_languages.map(l => l.code).join(', ')}`);

                    // æµ‹è¯•2: åˆ‡æ¢åˆ°è‹±è¯­
                    showTestResult('æ­£åœ¨åˆ‡æ¢åˆ° en...');
                    return fetch('/api/language/en', {method: 'POST'});
                })
                .then(r => r.json())
                .then(data => {
                    showTestResult(`åˆ‡æ¢ç»“æœ: ${JSON.stringify(data)}`);
                    if (data.success) {
                        showTestResult('è¯­è¨€åˆ‡æ¢æˆåŠŸï¼2ç§’åé‡æ–°åŠ è½½é¡µé¢...');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showTestResult(`è¯­è¨€åˆ‡æ¢å¤±è´¥: ${data.error}`, true);
                    }
                })
                .catch(error => {
                    showTestResult(`æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`, true);
                });
        }

        // è‡ªåŠ¨è¯­è¨€æµ‹è¯•åŠŸèƒ½
        function autoTestLanguage() {
            console.log('=== å¼€å§‹è‡ªåŠ¨è¯­è¨€æµ‹è¯• ===');
            testLanguageNow();
        }

        // é¡µé¢åŠ è½½å10ç§’è‡ªåŠ¨æµ‹è¯•
        setTimeout(() => {
            console.log('10ç§’åè‡ªåŠ¨å¼€å§‹è¯­è¨€æµ‹è¯•...');
            autoTestLanguage();
        }, 10000);
    </script>
</body>
</html>
